<%- include('partials/header') %>
<div class="max-w-5xl mx-auto">
    <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
        <div>
            <h2 class="text-2xl font-bold tracking-wide">深度解析報告 (Deep Insight)</h2>
            <p class="text-xs text-gray-500 font-mono mt-1">ID: <%= Date.now() %> | SECURE CONNECTION</p>
        </div>
        <a href="/diagnose" class="px-4 py-2 border border-gray-600 rounded text-sm text-gray-400 hover:text-white hover:border-gray-400 transition font-mono"><i class="fa-solid fa-rotate-right mr-2"></i>RESET</a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-cardbg p-6 rounded-xl border border-gray-700 shadow-lg relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                <h3 class="text-blue-400 text-xs font-mono uppercase mb-2">Debt Ratio</h3>
                <div class="text-5xl font-bold text-white mb-2 font-mono"><%= ratio %><span class="text-xl text-gray-500">%</span></div>
                
                <% if (risk === '高危險') { %> 
                    <div class="inline-flex items-center px-3 py-1 bg-red-900/30 text-red-400 border border-red-500/30 rounded text-xs font-mono w-full justify-center">
                        <i class="fa-solid fa-triangle-exclamation mr-2"></i> CRITICAL LEVEL
                    </div>
                <% } else if (risk === '中度風險') { %> 
                    <div class="inline-flex items-center px-3 py-1 bg-yellow-900/30 text-yellow-400 border border-yellow-500/30 rounded text-xs font-mono w-full justify-center">
                        <i class="fa-solid fa-circle-exclamation mr-2"></i> WARNING LEVEL
                    </div>
                <% } else { %> 
                    <div class="inline-flex items-center px-3 py-1 bg-green-900/30 text-green-400 border border-green-500/30 rounded text-xs font-mono w-full justify-center">
                        <i class="fa-solid fa-check-circle mr-2"></i> OPTIMAL LEVEL
                    </div>
                <% } %>
            </div>

            <div class="bg-cardbg p-6 rounded-xl border border-gray-700 shadow-lg">
                <h3 class="text-gray-400 text-xs font-mono uppercase mb-4 border-b border-gray-700 pb-2">Raw Data</h3>
                <div class="space-y-3 font-mono text-sm">
                    <div class="flex justify-between"><span>Input_Income</span><span class="text-white"><%= income %>0,000</span></div>
                    <div class="flex justify-between"><span>Input_Debt</span><span class="text-white"><%= debt %>0,000</span></div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 bg-cardbg p-6 rounded-xl border border-gray-700 shadow-lg flex flex-col relative">
            <div class="absolute top-4 right-4 text-xs font-mono text-gray-600">MODEL v2.4.1</div>
            <h3 class="text-gray-300 text-sm font-bold mb-4 flex items-center"><i class="fa-solid fa-bullseye mr-2 text-blue-500"></i>五維度評估模型</h3>
            <div class="flex-1 relative min-h-[300px]"><canvas id="radarChart"></canvas></div>
        </div>
    </div>
    
    <div class="mt-6 bg-slate-900/80 border border-blue-500/30 p-6 rounded-xl relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-50"></div>
        <h3 class="text-blue-400 font-bold mb-3 flex items-center font-mono text-lg">
            <i class="fa-solid fa-terminal mr-2"></i>LOGIC_OUTPUT (邏輯推演結論)
        </h3>
        <p class="text-gray-300 leading-relaxed font-mono text-sm border-l-2 border-blue-500 pl-4">
            <% if (risk === '高危險') { %>
                >> 偵測到負債比率 (<%= ratio %>%) 超過安全閾值。<br>
                >> 根據《消費者債務清理條例》演算邏輯，建議啟動 [前置協商] 程序。<br>
                >> 系統已生成債務清冊草稿，建議立即匯出並進行法律審閱。
            <% } else { %>
                >> 財務結構掃描完成：系統判定為 [安全] 等級。<br>
                >> 建議執行 [定期定額] 還款策略 (預設參數：月收 20%)。<br>
                >> 持續監控利率變動因子即可。
            <% } %>
        </p>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('radarChart');
    const ratio = <%= ratio %>;
    const scoreDebt = Math.max(0, 100 - ratio); 
    const scoreCredit = ratio > 60 ? 40 : 85;
    const scoreCash = ratio > 50 ? 30 : 75;
    const scoreGrow = 60;
    const scoreRisk = Math.max(0, 100 - (ratio * 1.2));
    
    // 設定高科技配色
    Chart.defaults.color = '#64748b';
    Chart.defaults.borderColor = '#1e293b';
    Chart.defaults.font.family = '"Courier New", monospace'; // 字體改為等寬字，更有科技感

    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['LIABILITY', 'CREDIT', 'CASHFLOW', 'GROWTH', 'RISK_TOLERANCE'],
            datasets: [{
                label: 'Financial Matrix',
                data: [scoreDebt, scoreCredit, scoreCash, scoreGrow, scoreRisk],
                fill: true,
                backgroundColor: 'rgba(59, 130, 246, 0.15)',
                borderColor: '#3b82f6',
                borderWidth: 2,
                pointBackgroundColor: '#0f172a',
                pointBorderColor: '#3b82f6',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#3b82f6'
            }]
        },
        options: { 
            maintainAspectRatio: false, 
            scales: { 
                r: { 
                    angleLines: { display: true, color: '#334155' }, 
                    grid: { color: '#334155' },
                    pointLabels: { font: { size: 12 }, color: '#94a3b8' },
                    suggestedMin: 0, suggestedMax: 100 
                } 
            } 
        }
    });
</script>
<%- include('partials/footer') %>
